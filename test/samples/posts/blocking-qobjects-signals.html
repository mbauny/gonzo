<html>
<head>
<title> Blocking QObjects signals | Meet the engineer</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link media="all" rel="stylesheet" href="./style.css" />
</head>
<body>
<div id='content'>
<h1>Blocking QObjects signals</h1>
<h2>Motivation</h2>
<p>Blocking a QObject's signals is a thing that you seldom need to do but that will sometimes be your only valid choice. As trivial as it seems, this is something that my formers colleagues and I have, for a long time, done incorrectly. I hope this post will help you learn from our past mistakes!</p>
<h2>How to do it</h2>
<h3>The bad way</h3>
<p>What naturally comes to mind first is to do something like this:</p>
<pre lang="cpp"><code>// SPOILER: This might be DANGEROUS, depending on the context
void myFunction() {
    QObject myObject;
    myObject.blockSignals(true);
    // ...
    // insert here some code that relies on signals being blocked
    // ...
    myObject.blockSignals(false);
}
</code></pre>
<p>It is quite unlikely that something goes wrong here because <em>myObject</em> is a local object and you have a clear vision on its life-cycle. However, most of the time, you will be dealing with objects coming for another scope, like in the following example:</p>
<pre lang="cpp"><code>// SPOILER: This is WRONG
void myFunction(QObject* object) {
    object-&gt;blockSignals(true);
    // ...
    // insert here some code that relies on signals being blocked
    // ...
    object-&gt;blockSignals(false);
}
</code></pre>
<p>Still feels natural, right? But what would happen if someone were to use our function and block signals in the same way that we do?</p>
<pre lang="cpp"><code>// SPOILER: This is WRONG
QObject myObject;
myObject.blockSignals(true);
// ...
// insert here some code that relies on signals being blocked
// ...
myFunction(&amp;myObject);
// ...
// insert here some code that relies on signals STILL being blocked
// although they are NOT blocked anymore!
// ...
myObject.blockSignals(false);
</code></pre>
<p>Once <em>myFunction</em> returns, we continue to work with <em>myObject</em>, assuming that its signals are still blocked whereas the function has unblocked them behind our back! ðŸ˜±</p>
<h3>The good way</h3>
<p>Qt has one of the best <a href="https://doc.qt.io/qt-5/reference-overview.html#">documentation</a> around; let's see what it has to say about <a href="https://doc.qt.io/qt-5/qobject.html#blockSignals"><em>QObject::blockSignals(bool block)</em></a> (emphasis mine):</p>
<blockquote>
<p><em>If block is true, signals emitted by this object are blocked (i.e., emitting a signal will not invoke anything connected to it). If block is false, no such blocking will occur.</em></p>
<p><strong><em>The return value is the previous value of signalsBlocked().</em></strong></p>
</blockquote>
<p>You see here that <em>blockSignals</em> has a return value. It tells you whether signals where blocked before your call and thus to what state you are expected to restore the object once you are done.</p>
<p>The correct way to implement <em>myFunction</em> would therefore be something like that:</p>
<pre lang="cpp"><code>// SPOILER: This is RIGHT
void myFunction(QObject* object) {
    const bool blockedBefore = object-&gt;blockSignals(true);
    // ...
    // insert here some code that relies on signals being blocked
    // ...
    // restore previous signals state
    object-&gt;blockSignals(blockedBefore);
}
</code></pre>
<p>This may seem a bit fastidious but since Qt 5.3, we can take advantage of the very handy <a href="https://doc.qt.io/qt-5/qsignalblocker.html"><em>QSignalBlocker</em></a> class:</p>
<pre lang="cpp"><code>// SPOILER: This is even MORE RIGHT
void myFunction(QObject* object) {
    const QSignalBlocker blocker(object);
    // ...
    // insert here some code that relies on signals being blocked
    // ...
    // no need to manually unblock signals
}
</code></pre>
<p>Naturally <em>myFunction</em>'s callers should also rely on these same tools:</p>
<pre lang="cpp"><code>QObject myObject;
const QSignalBlocker(myObject);
// ...
// insert here some code that relies on signals being blocked
// ...
myFunction(&amp;myObject);
// ...
// insert here some code that relies on signals being blocked
// ...
</code></pre>
<h2>Take away</h2>
<ol>
<li>Avoid blocking signals manually and use <em>QSignalBlocker</em>;</li>
<li>Consistently refer to Qt's documentation;</li>
<li><em>QSignalBlocker</em> has an <a href="https://doc.qt.io/qt-5/qsignalblocker.html#unblock"><em>unblock</em></a> and a <a href="https://doc.qt.io/qt-5/qsignalblocker.html#reblock"><em>reblock</em></a> method that you might find useful.</li>
</ol>
</div>
</body>
</html>
